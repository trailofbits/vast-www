<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>VAST: Optimizer - VAST: MLIR for Program Analysis</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "VAST: Optimizer";
        var mkdocs_page_input_path = "Tools/vast-opt.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> VAST: MLIR for Program Analysis
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">Home</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">VAST: MLIR for Program Analysis</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">VAST: Optimizer</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/trailofbits/vast/edit/master/docs/Tools/vast-opt.md" class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="vast-optimizer">VAST: Optimizer</h1>
<p>After <code>mlir</code> module from <code>vast-cc</code> is produced, we can leverage our optimisation pipeline to transform module in various ways. The lowest level we can do is LLVM dialect, from which we can dump LLVM IR if desired.</p>
<p>Overall design philosophy is that passes try to be really modular, self-contained and doing one thing properly - all while trying to preserve provenance metadata. Sometimes this does not exactly hold (transformation from <code>HL</code> into <code>LL</code> is huge) but it is what we strive for. Passes will more often than not have some dependencies between themselves - always consult documentation if unsure and report an issue if wiki is out of date on this.</p>
<h3 id="metadata-and-passes">Metadata and passes</h3>
<p><strong>TODO</strong>(lukas): Improve once we have examples</p>
<p><strong>TL;DR</strong>: Vast provided passes always try to keep metadata (and they should do a good job), but for passes from other sources this does not hold and probably some heuristic will be used to re-compute them in best-effort.</p>
<h2 id="passes">Passes</h2>
<p>Passes we have implemented can be roughly grouped into several categories. We also note some of the native mlir passes that are needed to continue with transformations to reach LLVM dialect.</p>
<h3 id="type-lowering">Type lowering</h3>
<p>A common prerequisite for other passes is to lower <code>HL</code> types into standard types. This can be done in two steps:
 * <code>--vast-hl-lower-types</code>
   - Converts simple (non-struct) types according to provided data layout (embedded in the mlir module metadata).
 * <code>--vast-hl-structs-to-tuples</code>
   - Converts <code>HL</code> struct types into standard tuples</p>
<p>While these should be commutative, the preferred order is <code>--vast-hl-lower-types --vast-hl-structs-to-tuples</code></p>
<h3 id="hl-scf">HL -&gt; SCF</h3>
<ul>
<li><code>--vast-hl-to-scf</code></li>
<li>Requires:<ul>
<li>Type lowering</li>
</ul>
</li>
<li>Conversion of <code>HL</code> control flow ops (currently only <code>hl.if</code> and <code>hl.while</code>) into their <code>scf</code> equivalents. Since <code>scf</code> requires <code>i1</code> in their conditions, additional casts may be inserted to satisfy this requirement (currently they are emitted in <code>HL</code> however this behaviour should customisable eventually.</li>
</ul>
<p>To produce an LLVM following addition passes must be run
<code>--convert-scf-to-std --convert-std-to-llvm</code> and possibly <code>--vast-hl-to-ll</code> as well (or some equivalent, depending on how conditions are coerced)</p>
<h3 id="hl-ll">HL -&gt; LL</h3>
<ul>
<li><code>--vast-hl-to-ll</code></li>
<li>Requires:<ul>
<li>Type lowering</li>
<li>Some form of control flow lowering</li>
</ul>
</li>
<li>Lower all <code>HL</code> operation into their LLVM dialect equivalents - this is a rather huge pass, for details see its documentation.</li>
</ul>
<h3 id="llvm-dump">LLVM Dump</h3>
<ul>
<li><code>--vast-llvm-dump</code></li>
<li>Requires:<ul>
<li>Entire module must be in LLVM dialect (or have operation for which conversion hooks are provided)</li>
</ul>
</li>
<li>LLVM bitcode is dumped to <code>llvm::errs()</code> in human readable form. Since passes can run in parallel, dump to file is non-trivial.</li>
</ul>
<h2 id="example-usage">Example Usage</h2>
<p>Let's say we have file <code>main.c</code> which we want to lower into some dialect. First let's have a look at some generic invocations we may find handy:</p>
<p>To get mlir module via <code>vast-cc</code></p>
<pre><code class="language-bash">vast-cc --ccopts -xc --from-source main.c
</code></pre>
<p>A quick remainder
 * <code>--ccopts -xc</code> says we are doing <code>C</code> not <code>C++</code>
 * <code>--from-source file</code> says that source code comes from the file</p>
<p>Once we have the module, we can invoke <code>vast-opt</code>, with easiest way being a simple pipe</p>
<pre><code class="language-bash">vast-cc --ccopts -xc --from-source main.c | vast-opt pass-we-want another-pass-we-want
</code></pre>
<p>If we want, we can also chain pipes</p>
<pre><code class="language-bash">vast-cc --ccopts -xc --from-source main.c | vast-opt pass | vast-opt another-pass | ...
</code></pre>
<p>Now, let's say we want to lower into LLVM bitcode, therefore the invocation will look as follows</p>
<pre><code class="language-bash">vast-cc --ccopts -xc --from-source main.c | vast-opt --vast-hl-lower-types --vast-hl-structs-to-tuples
                                                     --vast-hl-to-scf --convert-scf-to-std --convert-std-to-llvm
                                                     --vast-hl-to-ll
</code></pre>
              
            </div>
          </div><footer>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/trailofbits/vast" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
